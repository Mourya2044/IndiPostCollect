<%- include('partials/header'); -%>

<section class="hero" id="home">
    <h1>Auction</h1>
    <p>Make your bid here.</p>
</section>

<div class="auction-grid">
    <!-- Stamp 1 Auction Container -->
    <div class="auction-container" data-stamp-id="1">
        <img src="/images/stamps/stamp1.jpeg" alt="Stamp 1" class="item-image" />
        <div id="current-bid-1">Current Bid: $0</div>
        <div id="bidder-name-1">Bidder: None</div>
        <input id="bid-input-1" type="number" placeholder="Enter your bid" />
        <button id="bid-btn-1">Place Bid</button>
        <div id="message-1"></div>
    </div>

    <!-- Stamp 2 Auction Container -->
    <div class="auction-container" data-stamp-id="2">
        <img src="/images/stamps/stamp2.jpeg" alt="Stamp 2" class="item-image" />
        <div id="current-bid-2">Current Bid: $0</div>
        <div id="bidder-name-2">Bidder: None</div>
        <input id="bid-input-2" type="number" placeholder="Enter your bid" />
        <button id="bid-btn-2">Place Bid</button>
        <div id="message-2"></div>
    </div>

    <!-- Stamp 3 Auction Container -->
    <div class="auction-container" data-stamp-id="3">
        <img src="/images/stamps/stamp3.jpeg" alt="Stamp 3" class="item-image" />
        <div id="current-bid-3">Current Bid: $0</div>
        <div id="bidder-name-3">Bidder: None</div>
        <input id="bid-input-3" type="number" placeholder="Enter your bid" />
        <button id="bid-btn-3">Place Bid</button>
        <div id="message-3"></div>
    </div>

    <!-- Stamp 4 Auction Container -->
    <div class="auction-container" data-stamp-id="4">
        <img src="/images/stamps/stamp4.jpeg" alt="Stamp 4" class="item-image" />
        <div id="current-bid-4">Current Bid: $0</div>
        <div id="bidder-name-4">Bidder: None</div>
        <input id="bid-input-4" type="number" placeholder="Enter your bid" />
        <button id="bid-btn-4">Place Bid</button>
        <div id="message-4"></div>
    </div>
</div>

<%- include('partials/footer'); -%>

<script>
    // Connect to the Socket.io server
    const socket = io(); // Connect to the server (default is localhost:3000)

    let currentBidderName = null;

    socket.on('auction-authenticated', (data) => {
            currentBidderName = data.username; // Set the global username
            console.log('Authenticated as:', currentBidderName);
        });

    // Mapping of stamp IDs to their respective elements
    const stampElements = {
        1: {
            currentBid: document.getElementById('current-bid-1'),
            bidderName: document.getElementById('bidder-name-1'),
            bidInput: document.getElementById('bid-input-1'),
            bidButton: document.getElementById('bid-btn-1'),
            message: document.getElementById('message-1')
        },
        2: {
            currentBid: document.getElementById('current-bid-2'),
            bidderName: document.getElementById('bidder-name-2'),
            bidInput: document.getElementById('bid-input-2'),
            bidButton: document.getElementById('bid-btn-2'),
            message: document.getElementById('message-2')
        },
        3: {
            currentBid: document.getElementById('current-bid-3'),
            bidderName: document.getElementById('bidder-name-3'),
            bidInput: document.getElementById('bid-input-3'),
            bidButton: document.getElementById('bid-btn-3'),
            message: document.getElementById('message-3')
        },
        4: {
            currentBid: document.getElementById('current-bid-4'),
            bidderName: document.getElementById('bidder-name-4'),
            bidInput: document.getElementById('bid-input-4'),
            bidButton: document.getElementById('bid-btn-4'),
            message: document.getElementById('message-4')
        }
    };

    // Current bids for each stamp
    const currentBids = {
        1: { value: 0, bidder: 'None' },
        2: { value: 0, bidder: 'None' },
        3: { value: 0, bidder: 'None' },
        4: { value: 0, bidder: 'None' }
    };

    socket.on('connect', () => {
        console.log('Connected to Socket.io server');
    });

    socket.on('update', (msg) => {
        const { stampId, data } = msg;
        currentBids[stampId] = data;
        updateStampUI(stampId);
    });

    socket.on('current', (msg) => {
        const { stampId, data } = msg;
        currentBids[stampId] = data;
        updateStampUI(stampId);
    });

    function updateStampUI(stampId) {
        const elements = stampElements[stampId];
        const bidData = currentBids[stampId];

        elements.currentBid.textContent = `Current Bid: Rs${ bidData.value }`;
        elements.bidderName.textContent = `Bidder: ${ bidData.bidder }`;
        elements.message.textContent = '';
    }

    // Add event listeners for each stamp's bid button
    Object.values(stampElements).forEach((elements, index) => {
        const stampId = index + 1;
        elements.bidButton.addEventListener('click', () => {
            const newBid = parseFloat(elements.bidInput.value);

            if (isNaN(newBid)) {
                elements.message.textContent = 'Please enter a valid bid amount.';
                return;
            }

            if (newBid <= currentBids[stampId].value) {
                elements.message.textContent = `Bid must be higher than the current bid of Rs${ currentBids[stampId].value }`;
                return;
            }

            // Send the new bid to the server
            socket.emit('bid', {
                stampId,
                data: {
                    value: newBid,
                    bidder: currentBidderName // Replace with dynamic bidder info if needed
                }
            });

            elements.bidInput.value = ''; // Clear input after submission
        });
    });

    socket.on('error', (error) => {
        console.error('Socket.io error:', error);
    });
</script>