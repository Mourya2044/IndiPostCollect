<%- include('partials/header'); -%>

<div class="marketplace-container">
    <header class="marketplace-header">
        <h1 class="marketplace-title">Stamp Collectors' Haven</h1>
        <p class="marketplace-description">Explore a curated collection of rare and historical stamps from around
            the world. Discover passionate philately with our exclusive stamp selections.</p>
    </header>

    <div id="loading-indicator" style="display:none;">Loading stamps...</div>
    <div id="error-message" style="display:none;">Error loading stamps</div>
    <main class="marketplace-listings" id="marketplace-listings"></main>


    <section class="marketplace-filters">
        <div class="filter-options">
            <fieldset class="filter-group">
                <legend>Stamp Types</legend>
                <label><input type="checkbox" name="filter-stamp-type" value="rare-stamps">Rare stamps</label>
                <label><input type="checkbox" name="filter-stamp-type" value="historical-collection">Historical
                    Collection</label>
                <label><input type="checkbox" name="filter-stamp-type" value="thematic-stamps">Thematic
                    Stamps</label>
                <label><input type="checkbox" name="filter-stamp-type" value="modern-releases">Modern
                    Releases</label>
                <label><input type="checkbox" name="filter-stamp-type" value="international-series">International
                    Series</label>
            </fieldset>

            <fieldset class="filter-group">
                <legend>Condition</legend>
                <label><input type="checkbox" name="filter-stamp-condition" value="mint"> Mint</label>
                <label><input type="checkbox" name="filter-stamp-condition" value="used"> Used</label>
            </fieldset>

            <fieldset class="filter-group">
                <legend>Price Range</legend>
                <input type="number" name="filter-price-min" placeholder="Min Price" min="0">
                <input type="number" name="filter-price-max" placeholder="Max Price" min="0">
            </fieldset>
        </div>
        <button class="filter-button">
            <i class="fas fa-filter"></i> Apply Filters
        </button>
    </section>

    <div id="loading">Loading stamps...</div>
    <div id="error-message">Error loading stamps</div>

    <main class="marketplace-listings" id="marketplace-listings">
        <article class="listing-card">
            <div class="listing-image">
                <img src="https://via.placeholder.com/300x250" alt="Lincoln Commemorative Stamp">
            </div>
            <div class="listing-content">
                <h3 class="listing-title">1955 US Lincoln Commemorative</h3>
                <p class="listing-description">Pristine mint condition commemorative stamp featuring Abraham
                    Lincoln. A must-have for US presidential stamp collectors.</p>
                <div class="listing-price">$25.00</div>
                <button class="add-to-cart">
                    <i class="fas fa-shopping-cart"></i> Add to Cart
                </button>
            </div>
        </article>

        <article class="listing-card">
            <div class="listing-image">
                <img src="https://via.placeholder.com/300x250" alt="Canada Airmail Stamp">
            </div>
            <div class="listing-content">
                <h3 class="listing-title">1942 Canada Maple Leaf Airmail</h3>
                <p class="listing-description">Vintage airmail stamp showcasing the iconic Canadian maple leaf.
                    Well-preserved historical piece from World War II era.</p>
                <div class="listing-price">$15.00</div>
                <button class="add-to-cart">
                    <i class="fas fa-shopping-cart"></i> Add to Cart
                </button>
            </div>
        </article>

        <article class="listing-card">
            <div class="listing-image">
                <img src="https://via.placeholder.com/300x250" alt="Queen Elizabeth II Stamp">
            </div>
            <div class="listing-content">
                <h3 class="listing-title">1960s UK Queen Elizabeth II Definitive</h3>
                <p class="listing-description">Immaculate mint condition definitive stamp featuring Queen Elizabeth II. A royal addition to any Commonwealth collection.</p>
                <div class="listing-price">$20.00</div>
                <button class="add-to-cart">
                    <i class="fas fa-shopping-cart"></i> Add to Cart
                </button>
            </div>
        </article>
    </main>
</div>

<%- include('partials/footer'); -%>

<script>
    const stampsList = document.getElementById("marketplace-listings");
        const loadingIndicator = document.getElementById("loading-indicator");
        const errorMessage = document.getElementById("error-message");

        document.querySelector('.filter-button').addEventListener('click', function () {
            // Collect checked checkboxes
            const stampTypes = Array.from(document.querySelectorAll('input[name="filter-stamp-type"]:checked'))
                .map(input => input.value);
            const conditions = Array.from(document.querySelectorAll('input[name="filter-stamp-condition"]:checked'))
                .map(input => input.value);

            // Create filter data object
            const filterData = {
                stampTypes,
                conditions
            };

            console.log('Filters Applied:', filterData);

            // Perform your filtering function
            applyFilters(filterData);
        });

        async function applyFilters(filterData) {
            const { stampTypes } = filterData;

            // Clear the current listings
            stampsList.innerHTML = '';
            errorMessage.style.display = 'none';

            if (stampTypes.length === 0) {
                errorMessage.style.display = 'block';
                errorMessage.textContent = 'Please select at least one stamp type to filter.';
                return;
            }

            loadingIndicator.style.display = 'block';

            // Fetch and display stamps for each selected type
            for (const type of stampTypes) {
                await loadStamps(type);
            }

            loadingIndicator.style.display = 'none';
        }

        async function loadStamps(category) {
            try {
                // Fetch stamps
                const stamps = await fetchStamps(category);

                // If no stamps are returned, display a message
                if (stamps.length === 0) {
                    errorMessage.style.display = 'block';
                    errorMessage.textContent = `No stamps found for the category: ${ category }`;
                } else {
                    // Render stamps
                    stamps.forEach(stamp => {
                        const stampElement = createStampElement(stamp);
                        stampsList.insertAdjacentHTML('beforeend', stampElement);
                    });
                }
            } catch (error) {
                console.error('Error loading stamps:', error);
                errorMessage.style.display = 'block';
                errorMessage.textContent = 'Error loading stamps';
            }
        }

        async function fetchStamps(category) {
            try {
                const response = await fetch(`http://localhost:3000/api/stamps/${ category }`);
                if (!response.ok) {
                    throw new Error('Failed to fetch stamps');
                }
                const stamps = await response.json();
                console.log('Fetched stamps:', stamps);

                return Array.isArray(stamps) ? stamps : [];
            } catch (error) {
                console.error('Error fetching stamps:', error);
                return [];
            }
        }

        function createStampElement(stamp) {
            return `
    <article class="listing-card">
        <div class="listing-image">
            <img src="${ stamp.image }" alt="${ stamp.name }">
        </div>
        <div class="listing-content">
            <h3 class="listing-title">${ stamp.name }</h3>
            <p class="listing-description">${ stamp.description }</p>
            <div class="listing-price">$${ stamp.price }</div>
            <button class="add-to-cart">
                <i class="fas fa-shopping-cart"></i> Add to Cart
            </button>
        </div>
    </article>`;
        }

</script>